<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #101418;
      --muted: #5b6b7a;
      --accent: #e04c4c;
      --accent-2: #1b8b8b;
      --panel: rgba(255, 255, 255, 0.88);
      --shadow: rgba(16, 20, 24, 0.12);
      --bg-1: #f6f0e6;
      --bg-2: #dfe7ef;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 0%, #fef6d8 0%, transparent 60%),
        radial-gradient(900px 500px at 90% 10%, #d5f2ff 0%, transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
      padding: 24px;
      overflow-x: hidden;
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      box-shadow: 0 12px 30px var(--shadow);
      padding: 24px;
      backdrop-filter: blur(8px);
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .title {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
    }

    .section {
      margin-top: 18px;
    }

    .section-title {
      font-size: 14px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0 0 12px;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 14px;
      overflow: hidden;
    }

    thead th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid rgba(16, 20, 24, 0.08);
    }

    tbody td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(16, 20, 24, 0.06);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .pill-buy {
      background: rgba(27, 139, 139, 0.12);
      color: var(--accent-2);
    }

    .pill-sell {
      background: rgba(224, 76, 76, 0.12);
      color: var(--accent);
    }

    .muted {
      color: var(--muted);
    }

    .addr {
      word-break: break-all;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
    }

    .form-grid label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    .form-grid select,
    .form-grid input,
    .form-grid textarea,
    .form-grid button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(16, 20, 24, 0.12);
      font-family: inherit;
      font-size: 14px;
      background: #fff;
      color: var(--ink);
    }

    .form-grid textarea {
      min-height: 84px;
      resize: vertical;
    }

    .form-grid button {
      cursor: pointer;
      border: none;
      color: #fff;
      background: var(--accent-2);
      font-weight: 600;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="header">
      <h1 class="title">Admin</h1>
    </div>
    <div id="admin-access-denied" class="status" style="display:none; color:#e04c4c; font-size:14px; margin-bottom:12px;">
      Admin access denied for this wallet.
    </div>

    <div class="section">
      <h2 class="section-title">Price API live updates</h2>
      <div class="form-grid">
        <div>
          <label for="live-updates-enabled">Live updates</label>
          <select id="live-updates-enabled">
            <option value="true" selected>Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="live-updates-save-btn" type="button">Save</button>
        </div>
      </div>
      <div id="live-updates-status" class="status">Ready</div>
    </div>

    <div class="section">
      <h2 class="section-title">Add new company</h2>
      <div class="form-grid">
        <div>
          <label for="list-stock">Company</label>
          <select id="list-stock"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="list-create-btn" type="button">List Symbol</button>
        </div>
      </div>
      <div id="list-status" class="status">Ready</div>
    </div>

    <div class="section">
      <h2 class="section-title">Dividends distribution</h2>
      <div class="form-grid">
        <div>
          <label for="div-symbol">Symbol</label>
          <select id="div-symbol"></select>
        </div>
        <div>
          <label for="div-per-share">TToken per share</label>
          <input id="div-per-share" type="text" value="0.10" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="div-distribute-btn" type="button">Distribute</button>
        </div>
      </div>
      <div id="div-status" class="status">Ready</div>
    </div>

    <div class="section">
      <h2 class="section-title">Merkle dividends</h2>
      <div class="form-grid">
        <div>
          <label for="merkle-div-symbol">Symbol</label>
          <select id="merkle-div-symbol"></select>
        </div>
        <div>
          <label for="merkle-div-per-share">TToken per share</label>
          <input id="merkle-div-per-share" type="text" value="0.10" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="merkle-div-auto-declare-btn" type="button">Auto Declare Merkle</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="merkle-tree-view-btn" type="button">View Latest Tree</button>
        </div>
      </div>
      <div id="merkle-div-status" class="status">Ready</div>
      <pre id="merkle-tree-preview" class="status" style="white-space:pre-wrap;max-height:260px;overflow:auto"></pre>
    </div>

    <div class="section">
      <h2 class="section-title">Leveraged products</h2>
      <div class="form-grid">
        <div>
          <label for="lev-admin-symbol">Base symbol</label>
          <select id="lev-admin-symbol"></select>
        </div>
        <div>
          <label for="lev-admin-leverage">Leverage</label>
          <select id="lev-admin-leverage">
            <option value="3">3x</option>
            <option value="5" selected>5x</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="lev-admin-create-btn" type="button">Create leveraged token</button>
        </div>
      </div>
      <div id="lev-admin-status" class="status">Ready</div>
    </div>

    <div class="section">
      <h2 class="section-title">Award next session controls</h2>
      <div class="form-grid">
        <div>
          <label for="award-next-window">Next window seconds</label>
          <input id="award-next-window" type="number" min="1" max="3600" step="1" value="60" />
        </div>
        <div>
          <label for="award-terminate-next">Terminate next session</label>
          <select id="award-terminate-next">
            <option value="false" selected>No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="award-session-save-btn" type="button">Save next session</button>
        </div>
      </div>
      <div id="award-session-status" class="status">Ready</div>
    </div>

    <div class="section">
      <h2 class="section-title">Stock controls</h2>
      <div class="form-grid">
        <div>
          <label for="lifecycle-symbol">Symbol</label>
          <select id="lifecycle-symbol"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="symbol-freeze-btn" type="button">Freeze</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="symbol-unfreeze-btn" type="button">Unfreeze</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="symbol-delist-btn" type="button">Delist</button>
        </div>
      </div>
      <div id="lifecycle-status" class="status">Ready</div>
      <table style="margin-top:12px">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Status</th>
            <th>Visible On Markets</th>
            <th>Tradable</th>
          </tr>
        </thead>
        <tbody id="lifecycle-table-body"></tbody>
      </table>
    </div>

    <div class="section">
      <h2 class="section-title">Order book (open)</h2>
      <!-- ongoing order thats looking to be filled -->
      <table>
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Side</th>
            <th>Symbol</th>
            <th>Price (cents)</th>
            <th>Qty</th>
            <th>Remaining</th>
            <th>Trader</th>
            <th>Active</th>
          </tr>
        </thead>
        <tbody id="open-orders-body"></tbody>
      </table>
    </div>

    <div class="section">
      <h2 class="section-title">Completed transactions</h2>
      <!-- completed transaction here -->
      <table>
        <thead>
          <tr>
            <th>Maker</th>
            <th>Taker</th>
            <th>Symbol</th>
            <th>Price (cents)</th>
            <th>Qty</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody id="fills-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    const openOrdersBody = document.getElementById("open-orders-body");
    const fillsBody = document.getElementById("fills-body");
    const listStock = document.getElementById("list-stock");
    const liveUpdatesEnabledSelect = document.getElementById("live-updates-enabled");
    const liveUpdatesSaveBtn = document.getElementById("live-updates-save-btn");
    const liveUpdatesStatus = document.getElementById("live-updates-status");
    const listCreateBtn = document.getElementById("list-create-btn");
    const listStatus = document.getElementById("list-status");
    const divSymbol = document.getElementById("div-symbol");
    const divPerShare = document.getElementById("div-per-share");
    const divDistributeBtn = document.getElementById("div-distribute-btn");
    const divStatus = document.getElementById("div-status");
    const merkleDivSymbol = document.getElementById("merkle-div-symbol");
    const merkleDivPerShare = document.getElementById("merkle-div-per-share");
    const merkleDivAutoDeclareBtn = document.getElementById("merkle-div-auto-declare-btn");
    const merkleTreeViewBtn = document.getElementById("merkle-tree-view-btn");
    const merkleTreePreview = document.getElementById("merkle-tree-preview");
    const merkleDivStatus = document.getElementById("merkle-div-status");
    const levAdminSymbol = document.getElementById("lev-admin-symbol");
    const levAdminLeverage = document.getElementById("lev-admin-leverage");
    const levAdminCreateBtn = document.getElementById("lev-admin-create-btn");
    const levAdminStatus = document.getElementById("lev-admin-status");
    const awardNextWindow = document.getElementById("award-next-window");
    const awardTerminateNext = document.getElementById("award-terminate-next");
    const awardSessionSaveBtn = document.getElementById("award-session-save-btn");
    const awardSessionStatus = document.getElementById("award-session-status");
    const lifecycleSymbol = document.getElementById("lifecycle-symbol");
    const symbolFreezeBtn = document.getElementById("symbol-freeze-btn");
    const symbolUnfreezeBtn = document.getElementById("symbol-unfreeze-btn");
    const symbolDelistBtn = document.getElementById("symbol-delist-btn");
    const lifecycleStatus = document.getElementById("lifecycle-status");
    const lifecycleTableBody = document.getElementById("lifecycle-table-body");
    const adminAccessDenied = document.getElementById("admin-access-denied");
    const adminSections = Array.from(document.querySelectorAll(".section"));
    let lifecycleBySymbol = {};
    // JSDOM
    const LISTABLE_STOCKS = [
      { symbol: "AAPL", name: "Apple Inc" },
      { symbol: "MSFT", name: "Microsoft" },
      { symbol: "NVDA", name: "NVIDIA" },
      { symbol: "AMZN", name: "Amazon" },
      { symbol: "GOOGL", name: "Alphabet" },
      { symbol: "META", name: "Meta Platforms" },
      { symbol: "TSLA", name: "Tesla" },
      { symbol: "AVGO", name: "Broadcom" },
      { symbol: "NFLX", name: "Netflix" },
      { symbol: "AMD", name: "AMD" },
      { symbol: "INTC", name: "Intel" },
      { symbol: "ORCL", name: "Oracle" },
      { symbol: "CSCO", name: "Cisco" },
      { symbol: "ADBE", name: "Adobe" },
      { symbol: "QCOM", name: "Qualcomm" },
      { symbol: "JPM", name: "JPMorgan Chase" },
      { symbol: "V", name: "Visa" },
      { symbol: "MA", name: "Mastercard" },
      { symbol: "WMT", name: "Walmart" },
      { symbol: "COST", name: "Costco" },
    ];

    function shortAddress(address) {
      return String(address);
      // keep full address for transparency
    }

    async function getCurrentWallet() {
      if (!window.ethereum) {
        return "";
      }
      const accounts = await window.ethereum.request({ method: "eth_accounts" });
      if (Array.isArray(accounts) && accounts.length > 0) {
        return String(accounts[0]);
      }
      return "";
    }

    async function verifyAdminAccess() {
      try {
        const wallet = await getCurrentWallet();
        if (!wallet) {
          adminAccessDenied.style.display = "block";
          adminAccessDenied.textContent = "Connect wallet first. Admin access denied.";
          for (let i = 0; i < adminSections.length; i += 1) {
            adminSections[i].style.display = "none";
          }
          return false;
        }
        const res = await fetch(`/api/ui/permissions?wallet=${encodeURIComponent(wallet)}`);
        const data = await res.json();
        const allowed = Boolean(res.ok && data && data.canAccessAdminPage === true);
        if (!allowed) {
          adminAccessDenied.style.display = "block";
          adminAccessDenied.textContent = `Admin access denied for wallet ${wallet}`;
          for (let i = 0; i < adminSections.length; i += 1) {
            adminSections[i].style.display = "none";
          }
          return false;
        }
        adminAccessDenied.style.display = "none";
        for (let i = 0; i < adminSections.length; i += 1) {
          adminSections[i].style.display = "block";
        }
        return true;
      } catch {
        adminAccessDenied.style.display = "block";
        adminAccessDenied.textContent = "Unable to verify admin access.";
        for (let i = 0; i < adminSections.length; i += 1) {
          adminSections[i].style.display = "none";
        }
        return false;
      }
    }

    function formatQty(wei) {
      const value = Number(wei) / 1e18;
      return value.toFixed(2);
      // to fixed 2 dc
    }

    function setDivStatus(text, isError = false) {
      divStatus.textContent = text;
      let nextColor = "#5b6b7a";
      if (isError) {
        nextColor = "#e04c4c";
      }
      divStatus.style.color = nextColor;
    }

    function setMerkleDivStatus(text, isError = false) {
      merkleDivStatus.textContent = text;
      let nextColor = "#5b6b7a";
      if (isError) {
        nextColor = "#e04c4c";
      }
      merkleDivStatus.style.color = nextColor;
    }

    function setListStatus(text, isError = false) {
      listStatus.textContent = text;
      let nextColor = "#5b6b7a";
      if (isError) {
        nextColor = "#e04c4c";
      }
      listStatus.style.color = nextColor;
    }

    function setLeveragedStatus(text, isError = false) {
      levAdminStatus.textContent = text;
      let nextColor = "#5b6b7a";
      if (isError) {
        nextColor = "#e04c4c";
      }
      levAdminStatus.style.color = nextColor;
    }

    function setLifecycleStatus(text, isError = false) {
      lifecycleStatus.textContent = text;
      let nextColor = "#5b6b7a";
      if (isError) {
        nextColor = "#e04c4c";
      }
      lifecycleStatus.style.color = nextColor;
    }

    function setAwardSessionStatus(text, isError = false) {
      awardSessionStatus.textContent = text;
      let nextColor = "#5b6b7a";
      if (isError) {
        nextColor = "#e04c4c";
      }
      awardSessionStatus.style.color = nextColor;
    }

    function setLiveUpdatesStatus(text, isError = false) {
      liveUpdatesStatus.textContent = text;
      let nextColor = "#5b6b7a";
      if (isError) {
        nextColor = "#e04c4c";
      }
      liveUpdatesStatus.style.color = nextColor;
    }

    async function loadLiveUpdatesControl() {
      try {
        setLiveUpdatesStatus("Loading live updates state");
        const res = await fetch("/api/admin/live-updates");
        const data = await res.json();
        if (!res.ok || data.error) {
          let message = "Failed to load live updates state";
          if (data && data.error) {
            message = String(data.error);
          }
          throw new Error(message);
        }
        liveUpdatesEnabledSelect.value = data.enabled === false ? "false" : "true";
        setLiveUpdatesStatus(data.enabled === false ? "Live updates disabled" : "Live updates enabled");
      } catch (err) {
        let message = "Failed to load live updates state";
        if (err.message) {
          message = err.message;
        }
        setLiveUpdatesStatus(message, true);
      }
    }

    async function saveLiveUpdatesControl() {
      try {
        const wallet = await getCurrentWallet();
        if (!wallet) {
          throw new Error("Connect wallet first");
        }
        const enabled = liveUpdatesEnabledSelect.value === "true";
        setLiveUpdatesStatus("Saving live updates state");
        const res = await fetch("/api/admin/live-updates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet, enabled }),
        });
        const data = await res.json();
        if (!res.ok || data.error) {
          let message = "Failed to save live updates state";
          if (data && data.error) {
            message = String(data.error);
          }
          throw new Error(message);
        }
        liveUpdatesEnabledSelect.value = data.enabled === false ? "false" : "true";
        setLiveUpdatesStatus(data.enabled === false ? "Live updates disabled" : "Live updates enabled");
      } catch (err) {
        let message = "Failed to save live updates state";
        if (err.message) {
          message = err.message;
        }
        setLiveUpdatesStatus(message, true);
      }
    }

    async function loadDividendSymbols() {
      const res = await fetch("/api/registry/listings");
      const data = await res.json();
      divSymbol.innerHTML = "";
      merkleDivSymbol.innerHTML = "";
      levAdminSymbol.innerHTML = "";
      let rows = [];
      if (Array.isArray(data.listings)) {
        rows = data.listings;
      }
      for (const item of rows) {
        const option = document.createElement("option");
        option.value = item.symbol;
        option.textContent = item.symbol;
        divSymbol.appendChild(option);
        const merkleOption = document.createElement("option");
        merkleOption.value = item.symbol;
        merkleOption.textContent = item.symbol;
        merkleDivSymbol.appendChild(merkleOption);
        const levOption = document.createElement("option");
        levOption.value = item.symbol;
        levOption.textContent = item.symbol;
        levAdminSymbol.appendChild(levOption);
      }
    }

    async function loadLifecycleTable() {
      const res = await fetch("/api/admin/symbols/status");
      const data = await res.json();
      lifecycleTableBody.innerHTML = "";
      lifecycleSymbol.innerHTML = "";
      lifecycleBySymbol = {};
      let rows = [];
      if (Array.isArray(data.symbols)) {
        rows = data.symbols;
      }
      for (let i = 0; i < rows.length; i += 1) {
        const row = rows[i];
        lifecycleBySymbol[String(row.symbol).toUpperCase()] = row;
        const opt = document.createElement("option");
        opt.value = row.symbol;
        opt.textContent = row.symbol;
        lifecycleSymbol.appendChild(opt);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.symbol}</td>
          <td>${row.status}</td>
          <td>${row.visibleOnMarkets}</td>
          <td>${row.tradable}</td>
        `;
        lifecycleTableBody.appendChild(tr);
      }
    }

    async function changeSymbolLifecycle(action) {
      try {
        const symbol = String(lifecycleSymbol.value).toUpperCase();
        if (!symbol) {
          setLifecycleStatus("Select symbol first", true);
          return;
        }
        setLifecycleStatus(`Submitting ${action}`);
        const res = await fetch(`/api/admin/symbols/${action}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ symbol }),
        });
        const data = await res.json();
        let failed = false;
        if (!res.ok || data.error) {
          failed = true;
        }
        if (failed) {
          let message = "Lifecycle update failed";
          if (data.error) {
            message = data.error;
          }
          throw new Error(message);
        }
        setLifecycleStatus(`${symbol} set to ${data.status}`);
        await loadLifecycleTable();
      } catch (err) {
        let message = "Lifecycle update failed";
        if (err.message) {
          message = err.message;
        }
        setLifecycleStatus(message, true);
      }
    }

    async function loadListableStocks() {
      listStock.innerHTML = "";
      let firstUnlistedValue = "";
      let firstRelistValue = "";
      for (const stock of LISTABLE_STOCKS) {
        const option = document.createElement("option");
        option.value = stock.symbol;
        const row = lifecycleBySymbol[String(stock.symbol).toUpperCase()];
        let status = "";
        if (row && row.status) {
          status = String(row.status).toUpperCase();
        }
        if (status === "ACTIVE") {
          option.textContent = `${stock.name} (${stock.symbol}) — LISTED`;
          option.disabled = true;
        } else {
          let statusIsRelistable = false;
          if (status === "FROZEN" || status === "DELISTED") {
            statusIsRelistable = true;
          }
          if (statusIsRelistable) {
          option.textContent = `${stock.name} (${stock.symbol}) — RELIST`;
          option.disabled = false;
          if (!firstRelistValue) {
            firstRelistValue = stock.symbol;
          }
          } else {
            option.textContent = `${stock.name} (${stock.symbol})`;
            option.disabled = false;
          }
        }
        if (!option.disabled && !firstUnlistedValue) {
          firstUnlistedValue = stock.symbol;
        }
        listStock.appendChild(option);
      }
      if (firstRelistValue) {
        listStock.value = firstRelistValue;
      } else if (firstUnlistedValue) {
        listStock.value = firstUnlistedValue;
      }
    }

    async function distributeDividend() {
      try {
        setDivStatus("Submitting distribution");
        const payload = {
          symbol: divSymbol.value,
          divPerShare: divPerShare.value,
        };
        const res = await fetch("/api/dividends/declare", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        let distributionFailed = false;
        if (!res.ok || data.error) {
          distributionFailed = true;
        }
        if (distributionFailed) {
          let message = "Distribution failed";
          if (data.error) {
            message = data.error;
          }
          throw new Error(message);
        }
        setDivStatus(`Distributed for ${payload.symbol} Tx: ${data.txHash}`);
      } catch (err) {
        let message = "Distribution failed";
        if (err.message) {
          message = err.message;
        }
        setDivStatus(message, true);
      }
    }

    async function declareMerkleDividendAuto() {
      try {
        setMerkleDivStatus("Building snapshot and merkle tree");
        const symbol = String(merkleDivSymbol.value).toUpperCase();
        const divPerShare = String(merkleDivPerShare.value).trim();
        const payload = {
          symbol,
          divPerShare,
          claimsUri: "",
        };
        const res = await fetch("/api/dividends/merkle/declare-auto", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        let failed = false;
        if (!res.ok || data.error) {
          failed = true;
        }
        if (failed) {
          let message = "Auto merkle declaration failed";
          if (data.error) {
            message = data.error;
          }
          throw new Error(message);
        }
        setMerkleDivStatus(`Merkle epoch ${data.epochId} auto-declared for ${data.symbol} Tx: ${data.txHash}`);
        await viewMerkleTree();
      } catch (err) {
        let message = "Auto merkle declaration failed";
        if (err.message) {
          message = err.message;
        }
        setMerkleDivStatus(message, true);
      }
    }

    async function viewMerkleTree() {
      try {
        const symbol = String(merkleDivSymbol.value).toUpperCase();
        if (!symbol) {
          setMerkleDivStatus("Select symbol first", true);
          return;
        }
        const epochsRes = await fetch(`/api/dividends/merkle/epochs?symbol=${encodeURIComponent(symbol)}`);
        const epochsData = await epochsRes.json();
        let epochsFailed = false;
        if (!epochsRes.ok || epochsData.error) {
          epochsFailed = true;
        }
        if (epochsFailed) {
          let message = "Could not load merkle epochs";
          if (epochsData.error) {
            message = epochsData.error;
          }
          throw new Error(message);
        }
        let rows = [];
        if (Array.isArray(epochsData.epochs)) {
          rows = epochsData.epochs;
        }
        if (rows.length === 0) {
          setMerkleDivStatus(`No merkle epochs found for ${symbol}`, true);
          merkleTreePreview.textContent = "";
          return;
        }
        let epochId = 0;
        for (let i = 0; i < rows.length; i += 1) {
          const nextEpoch = Number(rows[i].epochId);
          if (nextEpoch > epochId) {
            epochId = nextEpoch;
          }
        }
        setMerkleDivStatus(`Loading tree for epoch ${epochId}`);
        const res = await fetch(`/api/dividends/merkle/tree?epochId=${encodeURIComponent(epochId)}`);
        const data = await res.json();
        let treeViewFailed = false;
        if (!res.ok || data.error) {
          treeViewFailed = true;
        }
        if (treeViewFailed) {
          let message = "Tree view failed";
          if (data.error) {
            message = data.error;
          }
          throw new Error(message);
        }
        const lines = [];
        lines.push(`${data.claimCount} users eligible for claims on ${data.symbol}`);
        lines.push(`Snapshot ${data.snapshotId}`);
        lines.push(``);
        let levels = [];
        if (Array.isArray(data.levels)) {
          levels = data.levels;
        }
        for (let i = 0; i < levels.length; i += 1) {
          const level = levels[i];
          lines.push(`Level ${level.level} size ${level.size}`);
          let nodes = [];
          if (Array.isArray(level.nodes)) {
            nodes = level.nodes;
          }
          for (let j = 0; j < nodes.length; j += 1) {
            const node = nodes[j];
            lines.push(`  [${node.index}] ${node.hash}`);
          }
        }
        merkleTreePreview.textContent = lines.join("\n");
        setMerkleDivStatus(`Tree loaded for epoch ${epochId}`);
      } catch (err) {
        let message = "Tree view failed";
        if (err.message) {
          message = err.message;
        }
        setMerkleDivStatus(message, true);
      }
    }

    async function createListing() {
      try {
        let listStockValue = "";
        if (listStock.value) {
          listStockValue = String(listStock.value);
        }
        const symbol = listStockValue.toUpperCase().trim();
        const selected = LISTABLE_STOCKS.find((s) => s.symbol === symbol);
        let name = symbol;
        if (selected) {
          name = selected.name;
        }
        let missingListingInput = false;
        if (!symbol || !name) {
          missingListingInput = true;
        }
        if (missingListingInput) {
          setListStatus("Please select a company", true);
          return;
        }
        const lifecycleRow = lifecycleBySymbol[symbol];
        let lifecycleStatus = "";
        if (lifecycleRow) {
          lifecycleStatus = String(lifecycleRow.status).toUpperCase();
        }
        if (listStock.selectedOptions[0] && listStock.selectedOptions[0].disabled && lifecycleStatus === "ACTIVE") {
          setListStatus(`${symbol} is already listed`, true);
          return;
        }
        let res;
        let isRelistStatus = false;
        if (lifecycleStatus === "DELISTED" || lifecycleStatus === "FROZEN") {
          isRelistStatus = true;
        }
        if (isRelistStatus) {
          setListStatus("Reactivating symbol");
          res = await fetch("/api/admin/symbols/list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol }),
          });
        } else {
          setListStatus("Listing symbol");
          res = await fetch("/api/equity/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol, name }),
          });
        }
        const data = await res.json();
        let listingFailed = false;
        if (!res.ok || data.error) {
          listingFailed = true;
        }
        if (listingFailed) {
          let message = "Listing failed";
          if (data.error) {
            message = data.error;
          }
          throw new Error(message);
        }
        if (isRelistStatus) {
          setListStatus(`Relisted ${symbol}`);
        } else {
          setListStatus(`Listed ${symbol} Tx: ${data.txHash}`);
        }
        await loadLifecycleTable();
        await loadListableStocks();
        await loadDividendSymbols();
      } catch (err) {
        let message = "Listing failed";
        if (err.message) {
          message = err.message;
        }
        setListStatus(message, true);
      }
    }

    async function createLeveragedProduct() {
      try {
        const baseSymbol = String(levAdminSymbol.value).toUpperCase();
        const leverage = Number(levAdminLeverage.value);
        setLeveragedStatus("Creating leveraged token");
        const res = await fetch("/api/leveraged/products/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ baseSymbol, leverage }),
        });
        const data = await res.json();
        let leveragedCreateFailed = false;
        if (!res.ok || data.error) {
          leveragedCreateFailed = true;
        }
        if (leveragedCreateFailed) {
          let message = "Leveraged creation failed";
          if (data.error) {
            message = data.error;
          }
          throw new Error(message);
        }
        setLeveragedStatus(`Created ${data.productSymbol} Tx: ${data.txHash}`);
      } catch (err) {
        let message = "Leveraged creation failed";
        if (err.message) {
          message = err.message;
        }
        setLeveragedStatus(message, true);
      }
    }

    async function loadAwardSessionControl() {
      try {
        const res = await fetch("/api/admin/award/session");
        const data = await res.json();
        let loadAwardSessionFailed = false;
        if (!res.ok || data.error) {
          loadAwardSessionFailed = true;
        }
        if (loadAwardSessionFailed) {
          let message = "Failed to load award session controls";
          if (data.error) {
            message = data.error;
          }
          throw new Error(message);
        }

        let nextAwardWindowValue = 60;
        if (data.nextAwardWindowSec) {
          nextAwardWindowValue = data.nextAwardWindowSec;
        }
        awardNextWindow.value = String(nextAwardWindowValue);
        if (data.terminateNextSession) {
          awardTerminateNext.value = "true";
        } else {
          awardTerminateNext.value = "false";
        }

        let text = "Ready";
        if (Number(data.nextAwardWindowAppliesAtEpoch) >= 0) {
          text = ``;
          if (data.terminateNextSession) {
            text = `${text} and termination enabled`;
          }
        }
        setAwardSessionStatus(text);
      } catch (err) {
        let message = "Failed to load award session controls";
        if (err.message) {
          message = err.message;
        }
        setAwardSessionStatus(message, true);
      }
    }

    async function saveAwardSessionControl() {
      try {
        const nextAwardWindowSec = Number(awardNextWindow.value);
        const terminateNextSession = awardTerminateNext.value === "true";
        setAwardSessionStatus("Saving next session controls");
        const res = await fetch("/api/admin/award/session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nextAwardWindowSec, terminateNextSession }),
        });
        const data = await res.json();
        let saveAwardSessionFailed = false;
        if (!res.ok || data.error) {
          saveAwardSessionFailed = true;
        }
        if (saveAwardSessionFailed) {
          let message = "Failed to save next session controls";
          if (data.error) {
            message = data.error;
          }
          throw new Error(message);
        }
        let text = `${data.nextAwardWindowSec}s`;
        if (data.terminateNextSession) {
          text = `${text} and termination enabled`;
        }
        setAwardSessionStatus(text);
      } catch (err) {
        let message = "Failed to save next session controls";
        if (err.message) {
          message = err.message;
        }
        setAwardSessionStatus(message, true);
      }
    }

    listCreateBtn.addEventListener("click", createListing);
    divDistributeBtn.addEventListener("click", distributeDividend);
    merkleDivAutoDeclareBtn.addEventListener("click", declareMerkleDividendAuto);
    merkleTreeViewBtn.addEventListener("click", viewMerkleTree);
    levAdminCreateBtn.addEventListener("click", createLeveragedProduct);
    liveUpdatesSaveBtn.addEventListener("click", saveLiveUpdatesControl);
    awardSessionSaveBtn.addEventListener("click", saveAwardSessionControl);
    symbolFreezeBtn.addEventListener("click", () => changeSymbolLifecycle("freeze"));
    symbolUnfreezeBtn.addEventListener("click", () => changeSymbolLifecycle("unfreeze"));
    symbolDelistBtn.addEventListener("click", () => changeSymbolLifecycle("delist"));
    (async function () {
      const hasAccess = await verifyAdminAccess();
      if (!hasAccess) {
        return;
      }
      await loadLifecycleTable();
      await loadListableStocks();
      await loadDividendSymbols();
      await loadLiveUpdatesControl();
      await loadAwardSessionControl();
      await loadLifecycleTable();
      const openRes = await fetch("/api/orderbook/open");
      const openData = await openRes.json();
      // rest api

      openOrdersBody.innerHTML = "";
      const activeOrders = [];
      let openRows = [];
      if (openRes.ok && openData && Array.isArray(openData.orders)) {
        openRows = openData.orders;
      }
      for (const order of openRows) {
        if (order.active === true && Number(order.remaining) > 0) {
          activeOrders.push(order);
          // add to existing order if active
        }
      }
      for (const order of activeOrders) {
        const tr = document.createElement("tr");
        let pillClass = "pill pill-sell";
        if (order.side === "BUY") {
          pillClass = "pill pill-buy";
        }
        tr.innerHTML = `
          <td>${order.id}</td>
          <td><span class="${pillClass}">${order.side}</span></td>
          <td>${order.symbol}</td>
          <td>${order.priceCents}</td>
          <td>${formatQty(order.qty)}</td>
          <td>${formatQty(order.remaining)}</td>
          <td class="muted addr">${shortAddress(order.trader)}</td>
          <td>${order.active}</td>
        `;
        openOrdersBody.appendChild(tr);
      }



      // satisfied order
      const fillsRes = await fetch("/api/orderbook/fills");
      const fillsData = await fillsRes.json();

      fillsBody.innerHTML = "";
      let fillRows = [];
      if (fillsRes.ok && fillsData && Array.isArray(fillsData.fills)) {
        fillRows = fillsData.fills;
      }
      for (const fill of fillRows) {
        const tr = document.createElement("tr");
        const date = new Date(fill.timestampMs);
        const formatter = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/New_York",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: true,
          timeZoneName: "short",
        });
        const formatted = formatter.format(date);
        tr.innerHTML = `
          <td class="muted addr">${shortAddress(fill.makerTrader)}</td>
          <td class="muted addr">${shortAddress(fill.takerTrader)}</td>
          <td>${fill.symbol}</td>
          <td>${fill.priceCents}</td>
          <td>${formatQty(fill.qty)}</td>
          <td class="muted">${formatted}</td>
        `;
        fillsBody.appendChild(tr);
      }
      if (fillRows.length === 0) {
        const tr = document.createElement("tr");
        const message = (fillsData && fillsData.error) ? String(fillsData.error) : "No completed transactions yet";
        tr.innerHTML = `<td colspan="6" class="muted">${message}</td>`;
        fillsBody.appendChild(tr);
      }
    })();
  </script>
</body>
</html>
