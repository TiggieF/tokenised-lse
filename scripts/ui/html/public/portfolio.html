<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Portfolio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #101418;
      --muted: #5b6b7a;
      --accent: #e04c4c;
      --accent-2: #1b8b8b;
      --panel: rgba(255, 255, 255, 0.85);
      --shadow: rgba(16, 20, 24, 0.12);
      --bg-1: #f6f0e6;
      --bg-2: #dfe7ef;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 0%, #fef6d8 0%, transparent 60%),
        radial-gradient(900px 500px at 90% 10%, #d5f2ff 0%, transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
      padding: 32px;
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      box-shadow: 0 12px 30px var(--shadow);
      padding: 24px;
      backdrop-filter: blur(8px);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .title {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
    }

    .toggle-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(16, 20, 24, 0.12);
      background: #fff;
      font-size: 12px;
      font-weight: 600;
      color: var(--ink);
      cursor: pointer;
    }

    .toggle-btn.disabled {
      color: var(--muted);
      background: rgba(255, 255, 255, 0.7);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 14px;
      overflow: hidden;
    }

    thead th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid rgba(16, 20, 24, 0.08);
    }

    tbody td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(16, 20, 24, 0.06);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .gain {
      font-weight: 600;
    }

    .gain.positive { color: var(--accent-2); }
    .gain.negative { color: var(--accent); }
    .gain.neutral { color: var(--muted); }

    .muted { color: var(--muted); }

    .section-header {
      margin-top: 24px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="header">
      <h1 class="title">Portfolio</h1>
      <button id="portfolio-toggle" class="toggle-btn">Enabled</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Quantity</th>
          <th>Cost Price</th>
          <th>Market Value</th>
          <th>Gain/Loss</th>
        </tr>
      </thead>
      <tbody id="portfolio-body"></tbody>
    </table>

    <div class="section-header">
      <h2 class="section-title">Cash</h2>
    </div>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody id="cash-body"></tbody>
    </table>
  </div>

  <script>
    let rows = [];
    let ttokenBalance = 0;

    const body = document.getElementById("portfolio-body");
    const cashBody = document.getElementById("cash-body");
    const toggleBtn = document.getElementById("portfolio-toggle");

    let pollingEnabled = true;
    let poller;
    const basePrices = new Map();
    let currentAccount;

    function formatMoney(value) {
      return `$${value.toFixed(2)}`;
    }

    function formatPct(value) {
      let sign = "";
      if (value > 0) {
        sign = "+";
      }
      return `${sign}${value.toFixed(2)}%`;
    }

    function getGainClass(value) {
      if (value > 0) {
        return "positive";
      }
      if (value < 0) {
        return "negative";
      }
      return "neutral";
    }

    async function fetchQuote(symbol) {
      const res = await fetch(
        `/api/fmp/quote-short?symbol=${encodeURIComponent(symbol)}`
      );
      const data = await res.json(
      );
      const requestFailed = !res.ok || data.error;
      if (requestFailed) {
        const message = data.error || "Quote failed";
        throw new Error(message);
      }
      return data.price;
    }

    async function loadTTokenBalance() {
      const res = await fetch(
        `/api/ttoken/balance?address=${encodeURIComponent(currentAccount)}`
      );
      const data = await res.json(
      );
      const balanceWei = Number(data.balanceWei);
      ttokenBalance = balanceWei / 1e18;
      renderCash();
    }

    async function loadBalances() {
      const res = await fetch(
        `/api/equity/balances?address=${encodeURIComponent(currentAccount)}`
      );
      const data = await res.json(
      );
      const requestFailed = !res.ok || data.error;
      if (requestFailed) {
        rows = [];
        renderTable();
        return;
      }
      const nextRows = [];
      for (const item of data.balances) {
        const qty = Number(item.balanceWei) / 1e18;
        if (qty > 0) {
          nextRows.push({ symbol: item.symbol, qty });
        }
      }
      rows = nextRows;
      renderTable();
    }

    async function refreshPortfolio() {
      await loadBalances(
      );
      await loadTTokenBalance(
      );
      for (const row of rows) {
        try {
          const price = await fetchQuote(
            row.symbol
          );
          const hasBasePrice = basePrices.has(row.symbol);
          if (!hasBasePrice) {
            basePrices.set(row.symbol, price);
          }
          row.price = price;
        } catch (err) {
          // ignore per-row errors
        }
      }
      renderTable();
    }

    function renderTable() {
      body.innerHTML = "";
      if (rows.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="muted" colspan="5">No equity tokens in this wallet yet.</td>`;
        body.appendChild(tr);
        return;
      }

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const base = basePrices.get(row.symbol);
        let price = base;
        price = row.price;
        const marketValue = row.qty * price;
        const marketValueDisplay = formatMoney(marketValue);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.symbol}</td>
          <td>${row.qty.toFixed(2)}</td>
          <td class="muted">x</td>
          <td>${marketValueDisplay}</td>
          <td class="muted">x</td>
        `;
        tr.addEventListener("click", () => {
          const nextUrl = `/sell.html?symbol=${encodeURIComponent(row.symbol)}`;
          window.location.href = nextUrl;
        });
        body.appendChild(tr);
      }
    }

    function renderCash() {
      cashBody.innerHTML = "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>TToken</td>
        <td>${ttokenBalance.toFixed(2)}</td>
      `;
      cashBody.appendChild(tr);
    }

    function setPolling(enabled) {
      pollingEnabled = enabled;
      if (enabled) {
        toggleBtn.textContent = "Enabled";
      } else {
        toggleBtn.textContent = "Disabled";
      }
      const isDisabled = !enabled;
      toggleBtn.classList.toggle("disabled", isDisabled);
      if (poller) {
        clearInterval(poller);
      }
      if (enabled) {
        refreshPortfolio();
        poller = setInterval(refreshPortfolio, 10000);
      }
    }

    toggleBtn.addEventListener("click", () => {
      const nextState = !pollingEnabled;
      setPolling(nextState);
    });
    async function connectWallet() {
      const accounts = await window.ethereum.request(
        {
          method: "eth_requestAccounts",
        }
      );
      currentAccount = accounts[0];
      await refreshPortfolio(
      );
    }

    if (window.ethereum) {
      window.ethereum.on("accountsChanged", (accounts) => {
        currentAccount = accounts[0];
        refreshPortfolio();
      });
    }

    async function initPortfolio() {
      renderTable();
      renderCash();
      await connectWallet();
      setPolling(true);
    }

    initPortfolio();
  </script>
</body>
</html>
