<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Portfolio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #101418;
      --muted: #5b6b7a;
      --accent: #e04c4c;
      --accent-2: #1b8b8b;
      --panel: rgba(255, 255, 255, 0.85);
      --shadow: rgba(16, 20, 24, 0.12);
      --bg-1: #f6f0e6;
      --bg-2: #dfe7ef;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 0%, #fef6d8 0%, transparent 60%),
        radial-gradient(900px 500px at 90% 10%, #d5f2ff 0%, transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
      padding: 32px;
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      box-shadow: 0 12px 30px var(--shadow);
      padding: 24px;
      backdrop-filter: blur(8px);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .title {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
    }

    .wallet {
      color: var(--muted);
      font-size: 12px;
      word-break: break-all;
      margin-top: 4px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 18px;
    }

    .summary-card {
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid rgba(16, 20, 24, 0.08);
    }

    .summary-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 18px;
      font-weight: 600;
    }

    .section-header {
      margin-top: 24px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
    }
    .status-ok {
      color: var(--accent-2);
    }
    .status-warn {
      color: var(--accent);
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 14px;
      overflow: hidden;
    }

    thead th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid rgba(16, 20, 24, 0.08);
    }

    tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(16, 20, 24, 0.06);
      vertical-align: top;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .gain { font-weight: 600; }
    .gain.positive { color: var(--accent-2); }
    .gain.negative { color: var(--accent); }
    .gain.neutral { color: var(--muted); }

    .claim-btn {
      border: none;
      border-radius: 10px;
      padding: 7px 10px;
      background: var(--accent-2);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
    }

    .sell-btn {
      border: none;
      border-radius: 10px;
      padding: 7px 10px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
    }

    .action-stack {
      display: grid;
      gap: 6px;
      min-width: 130px;
    }

    .action-stack input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(16, 20, 24, 0.12);
      font-family: inherit;
      font-size: 12px;
      background: #fff;
    }

    .muted { color: var(--muted); }

    @media (max-width: 780px) {
      body { padding: 20px; }
      table { display: block; overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="header">
      <div>
        <h1 class="title">Portfolio</h1>
        <div id="wallet" class="wallet">Wallet: -</div>
      </div>
      <button id="refresh-btn" class="claim-btn" type="button">Refresh</button>
    </div>

    <div class="summary-grid" id="summary-grid"></div>
    <div id="drift-status" class="status status-ok">Rebuild vs aggregator: pending</div>

    <div class="section-header">
      <h2 class="section-title">Holdings</h2>
      <div id="holdings-status" class="status">Loading</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Quantity</th>
          <th>Avg Cost</th>
          <th>Current</th>
          <th>Source</th>
          <th>Cost Basis</th>
          <th>Market Value</th>
          <th>Realized</th>
        </tr>
      </thead>
      <tbody id="positions-body"></tbody>
    </table>

    <div class="section-header">
      <h2 class="section-title">Claimable Dividends</h2>
      <div id="dividends-status" class="status">Ready</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Claimable (TToken)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="dividends-body"></tbody>
    </table>

    <div class="section-header">
      <h2 class="section-title">Leveraged Positions</h2>
      <div id="leveraged-status" class="status">Ready</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Base Price</th>
          <th>Qty</th>
          <th>Avg Entry NAV (value of one unit)</th>
          <th>Current NAV(value of one unit)</th>
          <th>Current Value</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="leveraged-body"></tbody>
    </table>
  </div>

  <script>
    const walletEl = document.getElementById("wallet");
    const summaryGrid = document.getElementById("summary-grid");
    const positionsBody = document.getElementById("positions-body");
    const dividendsBody = document.getElementById("dividends-body");
    const holdingsStatus = document.getElementById("holdings-status");
    const dividendsStatus = document.getElementById("dividends-status");
    const leveragedStatus = document.getElementById("leveraged-status");
    const driftStatus = document.getElementById("drift-status");
    const refreshBtn = document.getElementById("refresh-btn");
    const leveragedBody = document.getElementById("leveraged-body");

    let currentWallet = "";
    let pollingEnabled = false;
    let poller;

    function formatWeiToToken(valueWei, digits = 4) {
      const num = Number(valueWei) / 1e18;
      return num.toFixed(digits);
    }

    function formatUsdFromWei(valueWei) {
      const num = Number(valueWei) / 1e18;
      return `$${num.toFixed(2)}`;
    }

    function formatCents(cents) {
      const num = Number(cents) / 100;
      return `$${num.toFixed(2)}`;
    }

    function gainClass(valueWei) {
      const n = Number(valueWei);
      if (n > 0) return "gain positive";
      if (n < 0) return "gain negative";
      return "gain neutral";
    }

    function renderSummary(summary) {
      const cards = [
        ["Cash", formatUsdFromWei(summary.cashValueWei)],
        ["Stock Value", formatUsdFromWei(summary.stockValueWei)],
        ["Leveraged Value", formatUsdFromWei(summary.leveragedValueWei)],
        ["Total Value", formatUsdFromWei(summary.totalValueWei)],
        ["Cost Basis", formatUsdFromWei(summary.totalCostBasisWei)],
        ["Realized PnL", formatUsdFromWei(summary.realizedPnlWei)],
      ];
      summaryGrid.innerHTML = "";
      for (const [label, value] of cards) {
        const card = document.createElement("div");
        card.className = "summary-card";
        card.innerHTML = `<div class="summary-label">${label}</div><div class="summary-value">${value}</div>`;
        summaryGrid.appendChild(card);
      }
    }

    function renderPositions(positions) {
      positionsBody.innerHTML = "";
      if (!positions.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="8" class="muted">No holdings yet</td>';
        positionsBody.appendChild(tr);
        return;
      }

      for (const p of positions) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.symbol}</td>
          <td>${formatWeiToToken(p.balanceWei, 2)}</td>
          <td>${formatCents(p.avgCostCents)}</td>
          <td>${formatCents(p.priceCents)}</td>
          <td>${p.priceSource}</td>
          <td>${formatUsdFromWei(p.costBasisWei)}</td>
          <td>${formatUsdFromWei(p.currentValueWei)}</td>
          <td class="${gainClass(p.realizedPnlWei)}">${formatUsdFromWei(p.realizedPnlWei)}</td>
        `;
        tr.addEventListener("click", () => {
          window.location.href = `/sell.html?symbol=${encodeURIComponent(p.symbol)}`;
        });
        positionsBody.appendChild(tr);
      }
    }

    async function claimDividend(symbol, epochId) {
      try {
        dividendsStatus.textContent = `Claiming ${symbol} dividend`;
        const res = await fetch("/api/dividends/claim", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet: currentWallet, symbol, epochId }),
        });
        const data = await res.json();
        if (!res.ok || data.error) {
          throw new Error(data.error);
        }
        dividendsStatus.textContent = `Claimed ${symbol}. Tx: ${data.txHash}`;
        await refreshPortfolio();
      } catch (err) {
        dividendsStatus.textContent = err.message;
      }
    }

    function renderClaimables(claimables) {
      dividendsBody.innerHTML = "";
      if (!claimables.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="3" class="muted">No dividends yet</td>';
        dividendsBody.appendChild(tr);
        return;
      }

      let shown = 0;
      for (const row of claimables) {
        if (!row.canClaim && !row.claimed) {
          continue;
        }
        if (!row.canClaim) continue;
        shown += 1;
        const tr = document.createElement("tr");
        const actionTd = document.createElement("td");
        if (row.canClaim) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "claim-btn";
          btn.textContent = "Claim";
          btn.addEventListener("click", () => claimDividend(row.symbol, row.epochId));
          actionTd.appendChild(btn);
        } else if (row.claimed) {
          actionTd.textContent = "Claimed";
          actionTd.className = "muted";
        } else {
          actionTd.textContent = "-";
          actionTd.className = "muted";
        }

        tr.innerHTML = `
          <td>${row.symbol}</td>
          <td>${formatWeiToToken(row.claimableWei, 2)}</td>
        `;
        tr.appendChild(actionTd);
        dividendsBody.appendChild(tr);
      }

      if (shown === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="3" class="muted">No claimable dividends right now</td>';
        dividendsBody.appendChild(tr);
      }
    }

    async function sellLeveragedPosition(productSymbol, qtyWei) {
      try {
        if (!currentWallet) {
          leveragedStatus.textContent = "Wallet not connected";
          return;
        }
        const qtyNumber = Number(qtyWei);
        if (!(qtyNumber > 0)) {
          leveragedStatus.textContent = "qty must be greater than 0";
          return;
        }
        leveragedStatus.textContent = `Selling ${productSymbol}`;
        const res = await fetch("/api/leveraged/unwind", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            wallet: currentWallet,
            productSymbol: productSymbol,
            qtyWei: qtyWei,
            minOutWei: "0",
          }),
        });
        const data = await res.json();
        if (!res.ok || data.error) {
          throw new Error(data.error || "Sell failed");
        }
        leveragedStatus.textContent = `Sold ${productSymbol} Tx: ${data.txHash}`;
        await refreshPortfolio();
      } catch (err) {
        leveragedStatus.textContent = err.message || "Sell failed";
      }
    }

    function renderLeveragedPositions(items) {
      leveragedBody.innerHTML = "";
      if (!items.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="7" class="muted">No leveraged positions</td>';
        leveragedBody.appendChild(tr);
        return;
      }
      for (const item of items) {
        const tr = document.createElement("tr");
        const actionTd = document.createElement("td");
        const actionWrap = document.createElement("div");
        actionWrap.className = "action-stack";

        const sellBtn = document.createElement("button");
        sellBtn.type = "button";
        sellBtn.className = "sell-btn";
        sellBtn.textContent = "Sell";
        sellBtn.addEventListener("click", async () => {
          try {
            await sellLeveragedPosition(item.productSymbol, item.qtyWei);
          } catch (err) {
            leveragedStatus.textContent = err.message || "Sell failed";
          }
        });

        actionWrap.appendChild(sellBtn);
        actionTd.appendChild(actionWrap);
        tr.innerHTML = `
          <td>${item.productSymbol}</td>
          <td>${formatCents(item.basePriceCents)}</td>
          <td>${formatWeiToToken(item.qtyWei, 6)}</td>
          <td>${formatCents(item.avgEntryPriceCents)}</td>
          <td>${formatCents(item.navCents)}</td>
          <td>${formatUsdFromWei(item.currentValueWei)}</td>
        `;
        tr.appendChild(actionTd);
        leveragedBody.appendChild(tr);
      }
    }

    async function refreshPortfolio() {
      holdingsStatus.textContent = "Loading";

      const [summaryRes, positionsRes, claimablesRes, leveragedRes] = await Promise.all([
        fetch(`/api/portfolio/summary?wallet=${encodeURIComponent(currentWallet)}`),
        fetch(`/api/portfolio/positions?wallet=${encodeURIComponent(currentWallet)}`),
        fetch(`/api/dividends/claimables?wallet=${encodeURIComponent(currentWallet)}`),
        fetch(`/api/leveraged/positions?wallet=${encodeURIComponent(currentWallet)}`),
      ]);

      const summaryData = await summaryRes.json();
      const positionsData = await positionsRes.json();
      const claimablesData = await claimablesRes.json();
      const leveragedData = await leveragedRes.json();

      if (!summaryRes.ok || summaryData.error) {
        holdingsStatus.textContent = summaryData.error;
        return;
      }
      if (!positionsRes.ok || positionsData.error) {
        holdingsStatus.textContent = positionsData.error;
        return;
      }

      renderSummary(summaryData);
      renderPositions(positionsData.positions);
      renderClaimables(claimablesData.claimables);
      renderLeveragedPositions(leveragedData.positions);
      if (summaryData.drift) {
        if (summaryData.drift.withinTolerance) {
          driftStatus.className = "status status-ok";
          driftStatus.textContent = "Rebuild vs aggregator: in sync";
        } else {
          driftStatus.className = "status status-warn";
          const cashDrift = formatUsdFromWei(summaryData.drift.cashDeltaWei);
          const stockDrift = formatUsdFromWei(summaryData.drift.stockDeltaWei);
          const totalDrift = formatUsdFromWei(summaryData.drift.totalDeltaWei);
          driftStatus.textContent =
            `Drift detected: cash ${cashDrift}, `
            + `stock ${stockDrift}, `
            + `total ${totalDrift}`;
        }
      } else {
        driftStatus.className = "status";
        driftStatus.textContent = "Rebuild vs aggregator: aggregator not available";
      }
      holdingsStatus.textContent = `Loaded ${positionsData.positions.length} positions`;
      dividendsStatus.textContent = "Ready";
      leveragedStatus.textContent = "Ready";
    }

    function setPolling(enabled) {
      pollingEnabled = enabled;
      if (poller) {
        clearInterval(poller);
      }
      if (enabled) {
        refreshPortfolio();
        poller = setInterval(refreshPortfolio, 10000);
      }
    }

    refreshBtn.addEventListener("click", refreshPortfolio);

    window.ethereum.on("accountsChanged", (accounts) => {
      currentWallet = accounts[0];
      walletEl.textContent = `Wallet: ${currentWallet}`;
      refreshPortfolio();
    });

    (async function init() {
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      currentWallet = accounts[0];
      walletEl.textContent = `Wallet: ${currentWallet}`;
      await refreshPortfolio();
      setPolling(pollingEnabled);
    })();

    window.addEventListener("message", (event) => {
      const payload = event.data;
      if (payload.type === "LIVE_UPDATES") {
        setPolling(payload.enabled);
      }
    });
  </script>
</body>
</html>
