<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Portfolio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #101418;
      --muted: #5b6b7a;
      --accent: #e04c4c;
      --accent-2: #1b8b8b;
      --panel: rgba(255, 255, 255, 0.85);
      --shadow: rgba(16, 20, 24, 0.12);
      --bg-1: #f6f0e6;
      --bg-2: #dfe7ef;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 0%, #fef6d8 0%, transparent 60%),
        radial-gradient(900px 500px at 90% 10%, #d5f2ff 0%, transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
      padding: 32px;
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      box-shadow: 0 12px 30px var(--shadow);
      padding: 24px;
      backdrop-filter: blur(8px);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .title {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 14px;
      overflow: hidden;
    }

    thead th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid rgba(16, 20, 24, 0.08);
    }

    tbody td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(16, 20, 24, 0.06);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .gain {
      font-weight: 600;
    }

    .gain.positive { color: var(--accent-2); }
    .gain.negative { color: var(--accent); }
    .gain.neutral { color: var(--muted); }

    .muted { color: var(--muted); }

    .section-header {
      margin-top: 24px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="header">
      <h1 class="title">Portfolio</h1>
    </div>
    <table>
      <thead>
        <tr>
          <!-- stock equity token display -->
          <th>Symbol</th>
          <th>Quantity</th>
          <th>Cost Price</th>
          <th>Market Value</th>
          <th>Gain/Loss</th>
        </tr>
      </thead>
      <tbody id="portfolio-body"></tbody>
    </table>

    <div class="section-header">
      <h2 class="section-title">Cash</h2>
    </div>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Quantity</th>
          <!-- ttoken display -->
        </tr>
      </thead>
      <tbody id="cash-body"></tbody>
    </table>
  </div>

  <script>
    let rows = [];
    let ttokenBalance = 0;

    const body = document.getElementById("portfolio-body");
    const cashBody = document.getElementById("cash-body");

    let pollingEnabled = false;
    let poller;
    const basePrices = new Map();
    let currentAccount;

    async function refreshPortfolio() {
      // refreshs portfolio by fetching and render
      const balancesRes = await fetch(
        `/api/equity/balances?address=${encodeURIComponent(currentAccount)}`
      );
      const balancesData = await balancesRes.json(
      );
      const balancesFailed = !balancesRes.ok || balancesData.error;
      if (balancesFailed) {
        rows = [];
        renderTable();
      } else {
        const nextRows = [];
        for (const item of balancesData.balances) {
          const qty = Number(item.balanceWei) / 1e18;
          if (qty > 0) {
            nextRows.push({ symbol: item.symbol, qty });
          }
        }
        rows = nextRows;
        renderTable();
      }

      const ttokenRes = await fetch(
        `/api/ttoken/balance?address=${encodeURIComponent(currentAccount)}`
      );
      const ttokenData = await ttokenRes.json(
      );
      const balanceWei = Number(ttokenData.balanceWei);
      ttokenBalance = balanceWei / 1e18;
      renderCash();

      if (!pollingEnabled) {
        renderTable();
        return;
      }

      for (const row of rows) {
        try {
          const quoteRes = await fetch(
            `/api/fmp/quote-short?symbol=${encodeURIComponent(row.symbol)}`
          );
          const quoteData = await quoteRes.json(
          );
          const quoteFailed = !quoteRes.ok || quoteData.error;
          if (quoteFailed) {
            const message = quoteData.error || "Quote failed";
            throw new Error(message);
          }
          const price = quoteData.price;
          const hasBasePrice = basePrices.has(row.symbol);
          if (!hasBasePrice) {
            basePrices.set(row.symbol, price);
          }
          row.price = price;
        } catch (err) {
          
        }
      }
      renderTable();
    }

    function renderTable() {
      // write table for equity token
      // and in the order of the equity token's order
      body.innerHTML = "";
      if (rows.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="muted" colspan="5">No equity tokens in this wallet yet.</td>`;
        body.appendChild(tr);
        return;
      }

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const base = basePrices.get(row.symbol);
        let price = base;
        price = row.price;
        const hasPrice = Number.isFinite(price);
        const marketValue = hasPrice ? row.qty * price : null;
        const marketValueDisplay = hasPrice ? `$${marketValue.toFixed(2)}` : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.symbol}</td>
          <td>${row.qty.toFixed(2)}</td>
          <td class="muted">x</td>
          <td>${marketValueDisplay}</td>
          <td class="muted">x</td>
        `;
        tr.addEventListener("click", () => {
          const nextUrl = `/sell.html?symbol=${encodeURIComponent(row.symbol)}`;
          window.location.href = nextUrl;
        });
        body.appendChild(tr);
      }
    }

    function renderCash() {
      // write cash table for ttoken
      cashBody.innerHTML = "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>TToken</td>
        <td>${ttokenBalance.toFixed(2)}</td>
      `;
      cashBody.appendChild(tr);
    }

    function setPolling(enabled) {
      pollingEnabled = enabled;
      if (poller) {
        clearInterval(poller);
      }
      if (enabled) {
        refreshPortfolio();
        poller = setInterval(refreshPortfolio, 10000);
        // portfolio auto refresh every 10s
      }
    }
    if (window.ethereum) {
      window.ethereum.on("accountsChanged", (accounts) => {
        currentAccount = accounts[0];
        refreshPortfolio();
      });
      // listens to wallet change and refresh
    }

    (async function () {
      renderTable();
      renderCash();
      // write table for token and equity token

      const accounts = await window.ethereum.request(
        {
          method: "eth_requestAccounts",
        }
        // request wallet connection
      );
      currentAccount = accounts[0];
      await refreshPortfolio(
        // intiial load
      );

      setPolling(pollingEnabled);
    })();

    window.addEventListener("message", (event) => {
      const payload = event.data;
      if (payload.type === "LIVE_UPDATES") {
        setPolling(payload.enabled);
        // live update for portfolio valuation
      }
    });
  </script>
</body>
</html>
